<!--//FALTA:
//-CONTROLAR QUE CUANDO TERMINE LA CUENTA ATRAS SE PARE EL JUEGO Y SE PONGA EN PANTALLA QUIEN HA SIDO EL GANADOR                       -------- OK
//-PONER UN BOTON PARA QUE AL PULSARLO COMIENCE EL JUEGO                                                                               -------- OK
//-UNA VEZ TERMINADA LA PARTIDA, SI SE PULSA DE NUEVO EL BOTON SE TIENEN QUE RESTABLECER LAS POSICIONES INICIALES DE LAS PALETAS
//-AÑADIRLE ILUMINACIÓN Y TEXTURAS AVANZADAS-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong 3D with Three.js</title>
    <style>
        body { margin: 0; }
        canvas {
            display: block;
            margin: 0 auto; /* Centra horizontalmente */
            position: absolute;
            top: 50%; /* Centra verticalmente */
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #scoreboard {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            font-size: 24px;
            color: black;
        }
        #btnStart {
            position: absolute;
            top: 90%;
            left: 50%;
        }
    </style>
</head>
<body>
    <div id="scoreboard">
        <span id="player1-score">Player 1: 0</span>
        <span id="timer">Time Left</span>
        <span id="player2-score">Player 2: 0</span>
    </div>
    <button class="btn btn-primary mt-4" id="btnStart" onclick="startGame()">Start Game</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer;
        let paddle1, paddle2, ball;
        let player1Score = 0, player2Score = 0;
        let player1Speed = 0, player2Speed = 0;
        let ballSpeed = { x: 2, y: 2 };
        let timeLeft = 10;
        let gameInterval;
        let playing = false;

        function init() {
            // Crear escena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);

            // Configurar cámara
            camera = new THREE.OrthographicCamera(-400, 400, 350, -350, 1, 1000);
            camera.position.z = 500;

            // Crear renderizador
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(800, 700);
            document.body.appendChild(renderer.domElement);

            // Crear terreno de juego
            const fieldGeometry = new THREE.PlaneGeometry(800, 700);
            const fieldMaterial = new THREE.MeshBasicMaterial({ color: 0xBEBEBE });
            const field = new THREE.Mesh(fieldGeometry, fieldMaterial);
            scene.add(field);

            // Crear paletas
            const paddleGeometry = new THREE.BoxGeometry(20, 100, 10);
            const paddleMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            paddle1 = new THREE.Mesh(paddleGeometry, paddleMaterial);
            paddle1.position.set(-370, 0, 0);
            scene.add(paddle1);

            paddle2 = new THREE.Mesh(paddleGeometry, paddleMaterial);
            paddle2.position.set(370, 0, 0);
            scene.add(paddle2);

            // Crear pelota
            const ballGeometry = new THREE.SphereGeometry(10, 32, 32);
            const ballMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            ball = new THREE.Mesh(ballGeometry, ballMaterial);
            scene.add(ball);

            // Iniciar juego
            gameInterval = setInterval(updateTimer, 1000);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);

            if (playing == true)
            {                
                // Movimiento de las paletas
                paddle1.position.y += player1Speed;
                paddle2.position.y += player2Speed;
                
                // Mantener las paletas dentro de los límites
                paddle1.position.y = Math.max(-300, Math.min(300, paddle1.position.y));
                paddle2.position.y = Math.max(-300, Math.min(300, paddle2.position.y));
                
                // Movimiento de la pelota
                ball.position.x += ballSpeed.x;
                ball.position.y += ballSpeed.y;
                
                // Rebote en las paredes superior e inferior
                if (ball.position.y >= 340 || ball.position.y <= -340) {
                    ballSpeed.y = -ballSpeed.y;
                }
                
                // Colisión con las paletas
                if (ball.position.x <= -350 && ball.position.y >= paddle1.position.y - 50 && ball.position.y <= paddle1.position.y + 50) {
                    ballSpeed.x = -ballSpeed.x;
                }
                if (ball.position.x >= 350 && ball.position.y >= paddle2.position.y - 50 && ball.position.y <= paddle2.position.y + 50) {
                    ballSpeed.x = -ballSpeed.x;
                }
                
                // Puntaje para los jugadores
                if (ball.position.x <= -400) {
                    player2Score++;
                    document.getElementById('player2-score').textContent = `Player 2: ${player2Score}`;
                    resetBall();
                }
                if (ball.position.x >= 400) {
                    player1Score++;
                    document.getElementById('player1-score').textContent = `Player 1: ${player1Score}`;
                    resetBall();
                }
                
                renderer.render(scene, camera);
            } else {
                renderer.render(scene, camera);
            }
        }
            
        function resetBall() {
            ball.position.set(0, 0, 0);
            ballSpeed.x = -ballSpeed.x;
        }

        function updateTimer() {
            if (playing == true) {
                timeLeft--;
                document.getElementById('timer').textContent = `Time Left: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(gameInterval);
                    playing = false;
                    endGame();
                }
            }
        }

        function endGame() {
            let result;
            if (player1Score > player2Score) {
                result = 'Player 1 wins';
            } else if (player2Score > player1Score) {
                result = 'Player 2 wins';
            } else {
                result = 'TIE';
            }
            
            // Cargar la fuente de manera asincrónica
            const loader = new THREE.FontLoader();
            loader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', function(font) {
                const textGeometry = new THREE.TextGeometry(result, {
                    font: font,
                    size: 50,
                    height: 5,
                });
                
                const textMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                const textMesh = new THREE.Mesh(textGeometry, textMaterial);
                textMesh.position.set(-200, 0, 0);
                scene.add(textMesh);
            });
        }

        function startGame(){
            playing = true;
            document.getElementById('timer').textContent = `Time Left: ${timeLeft}s`;
        }

        // Control de teclas para jugadores
        window.addEventListener('keydown', (event) => {
            switch (event.key) {
                case 'w':
                    player1Speed = 5;
                    break;
                case 's':
                    player1Speed = -5;
                    break;
                case 'ArrowUp':
                    player2Speed = 5;
                    break;
                case 'ArrowDown':
                    player2Speed = -5;
                    break;
            }
        });

        window.addEventListener('keyup', (event) => {
            switch (event.key) {
                case 'w':
                case 's':
                    player1Speed = 0;
                    break;
                case 'ArrowUp':
                case 'ArrowDown':
                    player2Speed = 0;
                    break;
            }
        });

        init();
    </script>
</body>
</html>
